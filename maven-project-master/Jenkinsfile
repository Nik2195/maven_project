pipeline
{
agent {
  label 'dev'
}

parameters {
  choice choices: ['dev', 'prod'], name: 'select_env'
}

environment{
  NAME = "NIKHIL"
}

tools {
  maven 'maven_test'
}

stages{

    stage ('build')
    {
        steps{
          script {
              dir('maven-project-master/') {
                sh 'mvn clean package -DskipTests=true'
          
        }
        }
        }
    }

    stage ('test')
    {
        parallel {
            stage('testA')
          {
              agent { label 'dev'}
              steps{
              script {
              dir('maven-project-master/') {
              echo "This is test A"
              sh "mvn test"
              }
              }
          }
          stage('testB')
          {
              agent { label 'dev'}
              steps{
              script {
              dir('maven-project-master/') {
              echo "This is test B"
              sh "mvn test"
              }
              }
          }
        }

   post {
        success {
            dir( "webapp/target/")
            {
              stash name: "maven-build", includes: "*.war"
            }
                }
            }
    }
    stage('deploy_dev')
    {
      when { expression {params.select_env == 'dev'}
      beforeAgent true}
      agent { label 'dev'}
      steps{
          dir("/var/www/html")
          {
              unstash "maven-build"
          }}
          sh """
          cd /var/www/html
          jar -xvf webapp.war
          """
      }
    }

}
}