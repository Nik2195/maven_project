pipeline{
  
  agent{
    label 'dev'
  }
  
  parameters {
  choice choices: ['dev', 'prod'], name: 'Server_test'
  }

  environment {
  NAME = "NIKHIL"
  }
  
  tools {
  maven 'maven_test'
  }

  stages{
  
    stage('build')
    {
      steps {
          dir('maven-project-master/'){
          sh 'mvn clean package -DskipTests=true '
          echo "hi $NAME"
          }       
      }
    }

    stage('test')
    {
      parallel {
        stage ('testA') 
        {
          agent { label 'dev' }
          steps
          {
            dir('maven-project-master/'){
              echo "This is step A"
              sh 'mvn test'
            } 
          }
        }
        stage ('testB')
      
        {
          agent { label 'dev' }
          steps
          {
            dir('maven-project-master/'){
            echo "This is step B"
            sh 'mvn test'
            } 
          }
        }
        post {
        success {
        dir("webapp/target/")
        {
          stash name: "maven-build", includes: "*.war"
        }
        }
        }
      }      
    }

    stage('dev')
    {
      when { expression {params.Server_test == 'dev'}
      beforeAgent true}
      agent { label 'dev'}
      steps{
        dir("/var/www/html")
        {
          unstash "maven-build"
        }
        sh """
        cd /var/www/html/
        jar -xvf webapp.war
        """
      }

    }

    post {
    success {
        dir("webapp/target/")
        {
          stash name: "maven-build", includes: "*.war"
        }
            }
    }
  
    



  }  
  
}